<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Importing a database from Nominatim • photon</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Importing a database from Nominatim">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">photon</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> Overview</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/photon.html"><span class="fa fa-book"></span> Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/nominatim-import.html"><span class="fa fa-database"></span> Import from Nominatim</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-search"></span> Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Importing a database from Nominatim</h1>
            
      

      <div class="d-none name"><code>nominatim-import.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">photon</span><span class="op">)</span></span></code></pre></div>
<p>As specified in the <a href="photon.html">introduction vignette</a>,
you can download pre-built search indices for selected country extracts.
If you require more freedom in providing the geocoding data, you can
choose to import from an existing Nominatim database. Importing from
Nominatim is also a requirement if you want to enable structured
geocoding queries. This vignette guides you through the setup and import
of an external Nominatim database as well as the setup of structured
geocoding support through OpenSearch-based photon.</p>
<p>Technically, Nominatim databases can only be reliably set up on Linux
systems. Here, we use the <code>mediagis/nominatim</code> docker image
to set up Nominatim irrespective of the operating system. You can use
the helper functions <code><a href="../reference/cmd_options.html">cmd_options()</a></code> and <code><a href="http://processx.r-lib.org/reference/run.html" class="external-link">run()</a></code>
to run a Nominatim docker. It is important to expose the port 5432 on
the host machine, otherwise photon is not able to connect to the
database.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cmd_options.html">cmd_options</a></span><span class="op">(</span></span>
<span>  e <span class="op">=</span> <span class="st">"PBF_URL=https://download.geofabrik.de/australia-oceania/samoa-latest.osm.pbf"</span>,</span>
<span>  e <span class="op">=</span> <span class="st">"NOMINATIM_PASSWORD=MNdtC2*pP#aMbe"</span>,</span>
<span>  e <span class="op">=</span> <span class="st">"FREEZE=true"</span>,</span>
<span>  p <span class="op">=</span> <span class="st">"8080:8080"</span>,</span>
<span>  p <span class="op">=</span> <span class="st">"5432:5432"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"nominatim"</span>,</span>
<span>  <span class="st">"mediagis/nominatim:4.4"</span>,</span>
<span>  use_double_hyphens <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nominatim</span> <span class="op">&lt;-</span> <span class="va"><a href="http://processx.r-lib.org/reference/process.html" class="external-link">process</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"docker"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"run"</span>, <span class="va">opts</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To verify that the database can be connected to, you can connect to
it from R.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpostgres.r-dbi.org" class="external-link">RPostgres</a></span><span class="op">)</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">Postgres</span><span class="op">(</span><span class="op">)</span>, password <span class="op">=</span> <span class="st">"MNdtC2*pP#aMbe"</span>, user <span class="op">=</span> <span class="st">"nominatim"</span><span class="op">)</span></span>
<span><span class="fu">dbGetInfo</span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span>
<span><span class="co">#&gt; $dbname</span></span>
<span><span class="co">#&gt; [1] "nominatim"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $host</span></span>
<span><span class="co">#&gt; [1] "localhost"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $port</span></span>
<span><span class="co">#&gt; [1] "5432"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $username</span></span>
<span><span class="co">#&gt; [1] "nominatim"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $protocol.version</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $server.version</span></span>
<span><span class="co">#&gt; [1] 140013</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $db.version</span></span>
<span><span class="co">#&gt; [1] 140013</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pid</span></span>
<span><span class="co">#&gt; [1] 604</span></span>
<span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code></pre></div>
<p>If the database can be connected to, you can start a new photon
instance and import the database using <code>$import()</code>. The
database import creates the folder <code>photon_data</code> inside the
given photon directory.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"photon"</span><span class="op">)</span></span>
<span><span class="va">photon</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_photon.html">new_photon</a></span><span class="op">(</span><span class="va">dir</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ java version "22" 2024-03-19</span></span>
<span><span class="co">#&gt; ℹ Java(TM) SE Runtime Environment (build 22+36-2370)</span></span>
<span><span class="co">#&gt; ℹ Java HotSpot(TM) 64-Bit Server VM (build 22+36-2370, mixed mode, sharing)</span></span>
<span><span class="co">#&gt; ✔ Successfully downloaded photon 0.5.0. [8.2s]        </span></span>
<span><span class="co">#&gt; ℹ No search index downloaded! Download one or import from a Nominatim database.</span></span>
<span><span class="co">#&gt; • Version: 0.5.0</span></span>
<span></span>
<span><span class="va">photon</span><span class="op">$</span><span class="fu">import</span><span class="op">(</span>host <span class="op">=</span> <span class="st">"localhost"</span>, password <span class="op">=</span> <span class="st">"MNdtC2*pP#aMbe"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:35,904 [main] WARN  org.elasticsearch.node.Node - version [5.6.16-SNAPSHOT] is a pre-release version of Elasticsearch and is not suitable for production</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:43,326 [main] INFO  de.komoot.photon.elasticsearch.Server - Started elastic search node</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:43,326 [main] INFO  de.komoot.photon.App - Make sure that the ES cluster is ready, this might take some time.</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:43,905 [main] INFO  de.komoot.photon.App - ES cluster is now ready.</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:45,299 [main] INFO  de.komoot.photon.App - Starting import from nominatim to photon with languages: en,fr,de,it</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:45,300 [main] INFO  de.komoot.photon.nominatim.NominatimConnector - Start importing documents from nominatim (global)</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:59,080 [main] INFO  de.komoot.photon.nominatim.ImportThread - Finished import of 2085 photon documents.</span></span>
<span><span class="co">#&gt; 2024-10-24 23:07:59,080 [main] INFO  de.komoot.photon.App - Imported data from nominatim to photon with languages: en,fr,de,it</span></span></code></pre></div>
<p>After the import has finished, you can start the photon instance.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">photon</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2024-10-24 23:26:46,360 [main] WARN  org.elasticsearch.node.Node - version [5.6.16-SNAPSHOT] is a pre-release version of Elasticsearch and is not suitable for production</span></span>
<span><span class="co">#&gt; ✔ Photon is now running. [11.1s]</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/geocode.html">geocode</a></span><span class="op">(</span><span class="st">"Apia"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 3 features and 13 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -171.7631 ymin: -13.83613 xmax: -171.7512 ymax: -13.82611</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 14</span></span>
<span><span class="co">#&gt;     idx osm_type     osm_id country osm_key city        street     countrycode osm_value name  state type  extent</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;         &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1     1 W        1322127938 Samoa   place   NA          NA         WS          city      Apia  Tuam… city  &lt;dbl&gt; </span></span>
<span><span class="co">#&gt; 2     1 W         723300892 Samoa   landuse Matautu Tai NA         WS          harbour   Apia… Tuam… other &lt;dbl&gt; </span></span>
<span><span class="co">#&gt; 3     1 W         666117780 Samoa   tourism Levili      Levili St… WS          attracti… Apia… Tuam… house &lt;dbl&gt; </span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: geometry &lt;POINT [°]&gt;</span></span></code></pre></div>
<div class="section level2">
<h2 id="opensearch">OpenSearch<a class="anchor" aria-label="anchor" href="#opensearch"></a>
</h2>
<p>Previous setups of photon were based on the ElasticSearch search
engine. Photon also offers a version that is based on <a href="https://opensearch.org/" class="external-link">OpenSearch</a>. This photon version is
necessary to enable structured geocoding queries. Currently, OpenSearch
photon still needs to be build manually using <a href="https://gradle.org/" class="external-link">gradle</a>. For this step, we assume a
working <code>photon-opensearch-0.5.0.jar</code> in the photon
directory.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set opensearch = TRUE to use OpenSearch photon</span></span>
<span><span class="va">photon</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_photon.html">new_photon</a></span><span class="op">(</span><span class="va">dir</span>, opensearch <span class="op">=</span> <span class="cn">TRUE</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set structured = TRUE to enable structured geocoding</span></span>
<span><span class="va">photon</span><span class="op">$</span><span class="fu">import</span><span class="op">(</span>host <span class="op">=</span> <span class="st">"localhost"</span>, password <span class="op">=</span> <span class="st">"MNdtC2*pP#aMbe"</span>, structured <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Again, the <code>$import()</code> method created a directory
<code>photon_data</code>, which is 10-20% larger than the ElasticSearch
version. After starting photon, you can verify that structured geocoding
is enabled by running <code><a href="../reference/structured.html">has_structured_support()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">photon</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/structured.html">has_structured_support</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Since structured geocoding now works, you can now send entire
datasets with structured address data. Structured geocoding allows you
to search for specific elements of an address instead of passing free
text queries. In the following example, we search for three different
spatial features by querying their state, street, and housenumber.
Photon is able to geocode them with very high precision due to the
detailed data structure we provide.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">place_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  housenumber <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"77C"</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  street <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Falealilli Cross Island Road"</span>, <span class="st">"Main Beach Road"</span>, <span class="st">"Le Mafa Pass Road"</span><span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tuamasaga"</span>, <span class="st">"Tuamasaga"</span>, <span class="st">"Atua"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/geocode.html">geocode</a></span><span class="op">(</span><span class="va">place_data</span>, limit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 3 features and 14 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -171.7759 ymin: -14.04544 xmax: -171.451 ymax: -13.8338</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 15</span></span>
<span><span class="co">#&gt;     idx osm_type    osm_id country osm_key  city      countrycode osm_value name    state type  extent housenumber street</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;list&gt; &lt;chr&gt;       &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1     1 W        319147189 Samoa   highway  Siumu Uta WS          primary   Faleal… Tuam… stre… &lt;dbl&gt;  NA          NA    </span></span>
<span><span class="co">#&gt; 2     2 W        569855981 Samoa   building Apia      WS          yes       NA      Tuam… house &lt;dbl&gt;  77C         Main …</span></span>
<span><span class="co">#&gt; 3     3 W         40681149 Samoa   highway  Lalomanu  WS          primary   Main S… Ātua  stre… &lt;dbl&gt;  NA          NA    </span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: geometry &lt;POINT [°]&gt;</span></span></code></pre></div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jonas Lieth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
